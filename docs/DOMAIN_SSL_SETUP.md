# ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆanke.jpï¼‰ã¨SSLå°å…¥ã‚¬ã‚¤ãƒ‰

VPSã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ133.18.122.123:3000ï¼‰ã‹ã‚‰ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆanke.jpï¼‰ã¸ã®ç§»è¡Œã¨ã€Let's Encrypt SSLã®å°å…¥æ‰‹é †

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
3. [ç¾åœ¨ã®æ§‹æˆ](#ç¾åœ¨ã®æ§‹æˆ)
4. [å°å…¥è¨ˆç”»](#å°å…¥è¨ˆç”»)
5. [ã‚¹ãƒ†ãƒƒãƒ—1: DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®š](#ã‚¹ãƒ†ãƒƒãƒ—1-dnsãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®š)
6. [ã‚¹ãƒ†ãƒƒãƒ—2: Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ](#ã‚¹ãƒ†ãƒƒãƒ—2-nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ)
7. [ã‚¹ãƒ†ãƒƒãƒ—3: Let's Encrypt SSLè¨¼æ˜æ›¸ã®å–å¾—](#ã‚¹ãƒ†ãƒƒãƒ—3-lets-encrypt-sslè¨¼æ˜æ›¸ã®å–å¾—)
8. [ã‚¹ãƒ†ãƒƒãƒ—4: SSLè‡ªå‹•æ›´æ–°ã®è¨­å®š](#ã‚¹ãƒ†ãƒƒãƒ—4-sslè‡ªå‹•æ›´æ–°ã®è¨­å®š)
9. [ã‚¹ãƒ†ãƒƒãƒ—5: ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°](#ã‚¹ãƒ†ãƒƒãƒ—5-ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°)
10. [ã‚¹ãƒ†ãƒƒãƒ—6: å‹•ä½œç¢ºèª](#ã‚¹ãƒ†ãƒƒãƒ—6-å‹•ä½œç¢ºèª)
11. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### **ç¾åœ¨ã®çŠ¶æ…‹**
- **URL**: http://133.18.122.123:3000
- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPï¼ˆæš—å·åŒ–ãªã—ï¼‰
- **ãƒãƒ¼ãƒˆ**: 3000ï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

### **ç›®æ¨™ã®çŠ¶æ…‹**
- **URL**: https://anke.jp
- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPSï¼ˆSSL/TLSæš—å·åŒ–ï¼‰
- **ãƒãƒ¼ãƒˆ**: 443ï¼ˆæ¨™æº–HTTPSï¼‰
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: HTTP â†’ HTTPSè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

---

## å‰ææ¡ä»¶

### **å¿…è¦ãªã‚‚ã®**
- âœ… VPSï¼ˆ133.18.122.123ï¼‰
- âœ… Nginxï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿: nginx/1.24.0ï¼‰
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆanke.jpï¼‰
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã®DNSç®¡ç†æ¨©é™
- âœ… SSHæ¥ç¶šï¼ˆubuntu@133.18.122.123ï¼‰

### **ç¢ºèªäº‹é …**
```bash
# Nginxã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
nginx -v
# å‡ºåŠ›: nginx version: nginx/1.24.0 (Ubuntu)

# Nginxã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
systemctl status nginx

# Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèª
pm2 status
```

---

## ç¾åœ¨ã®æ§‹æˆ

### **ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼
  â†“
  http://133.18.122.123:3000
  â†“
  Next.js (PM2ã§èµ·å‹•ã€ãƒãƒ¼ãƒˆ3000)
  â†“
  Supabase (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)
```

### **Nginxç¾åœ¨ã®è¨­å®š**
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `/etc/nginx/sites-available/default`
- **çŠ¶æ…‹**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆãƒãƒ¼ãƒˆ80ã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼‰
- **Next.jsã¨ã®é€£æº**: ãªã—ï¼ˆç›´æ¥ãƒãƒ¼ãƒˆ3000ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

---

## å°å…¥è¨ˆç”»

### **å…¨ä½“ã®æµã‚Œ**

```
ã€ãƒ•ã‚§ãƒ¼ã‚º1: DNSè¨­å®šã€‘
1. ç¾åœ¨ã®DNSè¨­å®šã‚’ç¢ºèªï¼ˆ133.18.234.69ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼‰
2. DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆanke.jp: 133.18.234.69 â†’ 133.18.122.123ï¼‰
3. DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆwww.anke.jp: 133.18.234.69 â†’ 133.18.122.123ï¼‰
4. SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹å ´åˆï¼‰
5. DNSä¼æ’­ã‚’å¾…ã¤ï¼ˆTTL 3600ç§’ã€é€šå¸¸1ã€œ2æ™‚é–“ï¼‰
6. DNSä¼æ’­ã‚’ç¢ºèªï¼ˆdig/nslookup/ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ï¼‰

ã€ãƒ•ã‚§ãƒ¼ã‚º2: Nginxè¨­å®šã€‘
3. anke.jpç”¨ã®Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
4. ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’è¨­å®šï¼ˆNginx â†’ Next.js:3000ï¼‰
5. Nginxè¨­å®šã‚’ãƒ†ã‚¹ãƒˆï¼†ãƒªãƒ­ãƒ¼ãƒ‰

ã€ãƒ•ã‚§ãƒ¼ã‚º3: SSLå°å…¥ã€‘
6. Certbotï¼ˆLet's Encryptï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
7. SSLè¨¼æ˜æ›¸ã‚’å–å¾—
8. HTTPSè¨­å®šã‚’è‡ªå‹•é©ç”¨
9. HTTP â†’ HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨­å®š

ã€ãƒ•ã‚§ãƒ¼ã‚º4: è‡ªå‹•æ›´æ–°ã€‘
10. SSLè¨¼æ˜æ›¸ã®è‡ªå‹•æ›´æ–°ã‚’è¨­å®š
11. CRONã‚¸ãƒ§ãƒ–ã§å®šæœŸæ›´æ–°

ã€ãƒ•ã‚§ãƒ¼ã‚º5: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã€‘
12. ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆNEXT_PUBLIC_APP_URLï¼‰
13. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•

ã€ãƒ•ã‚§ãƒ¼ã‚º6: å‹•ä½œç¢ºèªã€‘
14. HTTPSã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèª
15. HTTPãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç¢ºèª
16. SSLè¨¼æ˜æ›¸ã‚’ç¢ºèª
```

### **æ‰€è¦æ™‚é–“**
- **DNSè¨­å®š**: 5åˆ†
- **Nginxè¨­å®š**: 10åˆ†
- **SSLå°å…¥**: 10åˆ†
- **å‹•ä½œç¢ºèª**: 5åˆ†
- **åˆè¨ˆ**: ç´„30åˆ†ï¼ˆDNSä¼æ’­æ™‚é–“ã‚’é™¤ãï¼‰

---

## ã‚¹ãƒ†ãƒƒãƒ—1: DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®š

### **âš ï¸ é‡è¦: ç¾åœ¨ã®DNSè¨­å®šã‚’ç¢ºèª**

ç¾åœ¨ã®DNSè¨­å®šï¼ˆdnsv.jpï¼‰ï¼š
```
anke.jp.     3600 IN A 133.18.234.69  âŒ å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹
www.anke.jp. 3600 IN A 133.18.234.69  âŒ å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹
```

**å•é¡Œ**: IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¾åœ¨ã®VPSï¼ˆ`133.18.122.123`ï¼‰ã¨ç•°ãªã‚Šã¾ã™ã€‚

### **1-1. ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹**

anke.jpã®ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ç”»é¢ï¼ˆdnsv.jpï¼‰ã«ãƒ­ã‚°ã‚¤ãƒ³

### **1-2. Aãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°**

| ã‚¿ã‚¤ãƒ— | ãƒ›ã‚¹ãƒˆå | ç¾åœ¨ã®å€¤ | æ–°ã—ã„å€¤ | TTL |
|--------|---------|---------|---------|-----|
| A | @ | 133.18.234.69 | **133.18.122.123** | 3600 |
| A | www | 133.18.234.69 | **133.18.122.123** | 3600 |

- **@**: ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆanke.jpï¼‰
- **www**: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆwww.anke.jpï¼‰

### **1-3. SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚æ›´æ–°ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹å ´åˆï¼‰**

ç¾åœ¨ã®SPFãƒ¬ã‚³ãƒ¼ãƒ‰ï¼š
```
anke.jp. 3600 IN TXT "v=spf1 +a +mx +ip4:133.18.234.69 ~all"
```

æ–°ã—ã„SPFãƒ¬ã‚³ãƒ¼ãƒ‰ï¼š
```
anke.jp. 3600 IN TXT "v=spf1 +a +mx +ip4:133.18.122.123 ~all"
```

### **1-4. DNSä¼æ’­ã‚’ç¢ºèª**

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª
dig anke.jp
dig www.anke.jp

# ã¾ãŸã¯
nslookup anke.jp
nslookup www.anke.jp
```

æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€`133.18.122.123`ãŒè¿”ã•ã‚Œã¾ã™ã€‚

â±ï¸ **DNSä¼æ’­æ™‚é–“**: 
- **TTL**: 3600ç§’ï¼ˆ1æ™‚é–“ï¼‰
- **äºˆæƒ³ä¼æ’­æ™‚é–“**: 1ã€œ2æ™‚é–“
- **æœ€å¤§**: 24ã€œ48æ™‚é–“

### **1-5. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ç¢ºèª**

- https://www.whatsmydns.net/#A/anke.jp
- ä¸–ç•Œä¸­ã®DNSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç¢ºèªã§ãã¾ã™

### **âš ï¸ æ³¨æ„: å¤ã„ã‚µãƒ¼ãƒãƒ¼ï¼ˆ133.18.234.69ï¼‰ã«ã¤ã„ã¦**

DNSæ›´æ–°å¾Œã€å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åœæ­¢ã—ã¾ã™ï¼š

- **å¤ã„ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ**: äº‹å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- **å¤ã„ã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒä¸­ã®å ´åˆ**: DNSä¼æ’­å¾Œã«åœæ­¢å¯èƒ½
- **ç§»è¡Œå‰ã®ç¢ºèª**: å¤ã„ã‚µãƒ¼ãƒãƒ¼ã§ç¨¼åƒä¸­ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¢ºèª

---

## ã‚¹ãƒ†ãƒƒãƒ—2: Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

### **2-1. VPSã«SSHæ¥ç¶š**

```bash
ssh -i ~/.ssh/anke-nextjs.key ubuntu@133.18.122.123
```

### **2-2. anke.jpç”¨ã®Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ**

```bash
sudo nano /etc/nginx/sites-available/anke.jp
```

ä»¥ä¸‹ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ï¼š

```nginx
# anke.jp - Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
# HTTPè¨­å®šï¼ˆå¾Œã§CertbotãŒHTTPSè¨­å®šã‚’è‡ªå‹•è¿½åŠ ï¼‰

server {
    listen 80;
    listen [::]:80;
    
    server_name anke.jp www.anke.jp;
    
    # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    access_log /var/log/nginx/anke.jp.access.log;
    error_log /var/log/nginx/anke.jp.error.log;
    
    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æœ€å¤§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
    client_max_body_size 10M;
    
    # ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®šï¼ˆNext.js:3000ã¸è»¢é€ï¼‰
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Next.jsé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ_nextï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }
    
    # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }
}
```

ä¿å­˜ã—ã¦çµ‚äº†ï¼š
- `Ctrl + O` â†’ Enterï¼ˆä¿å­˜ï¼‰
- `Ctrl + X`ï¼ˆçµ‚äº†ï¼‰

### **2-3. ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ**

```bash
sudo ln -s /etc/nginx/sites-available/anke.jp /etc/nginx/sites-enabled/
```

### **2-4. Nginxè¨­å®šã‚’ãƒ†ã‚¹ãƒˆ**

```bash
sudo nginx -t
```

æ­£å¸¸ãªå ´åˆï¼š
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### **2-5. Nginxã‚’ãƒªãƒ­ãƒ¼ãƒ‰**

```bash
sudo systemctl reload nginx
```

### **2-6. å‹•ä½œç¢ºèªï¼ˆHTTPï¼‰**

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://anke.jp ã«ã‚¢ã‚¯ã‚»ã‚¹

âœ… Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK

---

## ã‚¹ãƒ†ãƒƒãƒ—3: Let's Encrypt SSLè¨¼æ˜æ›¸ã®å–å¾—

### **3-1. Certbotã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**

```bash
# Snapdã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUbuntu 24.04ã§ã¯é€šå¸¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰
sudo apt update
sudo apt install snapd -y

# Snapdã‚’æœ€æ–°åŒ–
sudo snap install core
sudo snap refresh core

# å¤ã„Certbotã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
sudo apt remove certbot -y

# Certbotã‚’Snapã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo snap install --classic certbot

# Certbotã‚³ãƒãƒ³ãƒ‰ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```

### **3-2. Certbotã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª**

```bash
certbot --version
```

### **3-3. SSLè¨¼æ˜æ›¸ã‚’å–å¾—**

```bash
sudo certbot --nginx -d anke.jp -d www.anke.jp
```

å¯¾è©±å½¢å¼ã§ä»¥ä¸‹ã‚’å…¥åŠ›ï¼š

1. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**: SSLè¨¼æ˜æ›¸ã®æ›´æ–°é€šçŸ¥ç”¨ï¼ˆä¾‹: info@anke.jpï¼‰
2. **åˆ©ç”¨è¦ç´„**: `Y`ï¼ˆåŒæ„ï¼‰
3. **ãƒ¡ãƒ¼ãƒ«é…ä¿¡**: `N`ï¼ˆä¸è¦ãªå ´åˆï¼‰

CertbotãŒè‡ªå‹•çš„ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
- âœ… SSLè¨¼æ˜æ›¸ã‚’å–å¾—
- âœ… Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«HTTPSè¨­å®šã‚’è¿½åŠ 
- âœ… HTTP â†’ HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨­å®š
- âœ… Nginxã‚’ãƒªãƒ­ãƒ¼ãƒ‰

### **3-4. SSLè¨¼æ˜æ›¸ã®ç¢ºèª**

```bash
sudo certbot certificates
```

å‡ºåŠ›ä¾‹ï¼š
```
Found the following certs:
  Certificate Name: anke.jp
    Domains: anke.jp www.anke.jp
    Expiry Date: 2026-04-15 12:00:00+00:00 (VALID: 89 days)
    Certificate Path: /etc/letsencrypt/live/anke.jp/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/anke.jp/privkey.pem
```

---

## ã‚¹ãƒ†ãƒƒãƒ—4: SSLè‡ªå‹•æ›´æ–°ã®è¨­å®š

### **4-1. è‡ªå‹•æ›´æ–°ã®ãƒ†ã‚¹ãƒˆ**

```bash
sudo certbot renew --dry-run
```

æ­£å¸¸ãªå ´åˆï¼š
```
Congratulations, all simulated renewals succeeded
```

### **4-2. è‡ªå‹•æ›´æ–°CRONã‚¸ãƒ§ãƒ–ã®ç¢ºèª**

Certbotã¯è‡ªå‹•çš„ã«CRONã‚¸ãƒ§ãƒ–ã¾ãŸã¯systemdã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

```bash
# systemdã‚¿ã‚¤ãƒãƒ¼ã‚’ç¢ºèª
systemctl list-timers | grep certbot

# ã¾ãŸã¯ã€CRONã‚¸ãƒ§ãƒ–ã‚’ç¢ºèª
sudo cat /etc/cron.d/certbot
```

### **4-3. æ‰‹å‹•æ›´æ–°ï¼ˆå¿…è¦ãªå ´åˆï¼‰**

```bash
sudo certbot renew
```

SSLè¨¼æ˜æ›¸ã¯90æ—¥é–“æœ‰åŠ¹ã§ã€30æ—¥å‰ã‹ã‚‰è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚

---

## ã‚¹ãƒ†ãƒƒãƒ—5: ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°

### **5-1. VPSã®.env.localã‚’æ›´æ–°**

```bash
cd /var/www/anke-nextjs
nano .env.local
```

ä»¥ä¸‹ã®è¡Œã‚’æ›´æ–°ï¼š

```env
# å¤‰æ›´å‰
NEXT_PUBLIC_APP_URL=http://133.18.122.123:3000

# å¤‰æ›´å¾Œ
NEXT_PUBLIC_APP_URL=https://anke.jp
```

ä¿å­˜ã—ã¦çµ‚äº†ï¼š
- `Ctrl + O` â†’ Enterï¼ˆä¿å­˜ï¼‰
- `Ctrl + X`ï¼ˆçµ‚äº†ï¼‰

### **5-2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•**

```bash
pm2 restart anke-nextjs
pm2 logs anke-nextjs --lines 50
```

### **5-3. ãƒ­ãƒ¼ã‚«ãƒ«ã®.env.localã‚’æ›´æ–°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ãƒªãƒ¢ãƒ¼ãƒˆAPIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ
open -a "TextEdit" .env.local
```

ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```env
# æœ¬ç•ªç’°å¢ƒURLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
NEXT_PUBLIC_APP_URL=https://anke.jp
```

---

## ã‚¹ãƒ†ãƒƒãƒ—6: å‹•ä½œç¢ºèª

### **6-1. HTTPSã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèª**

ãƒ–ãƒ©ã‚¦ã‚¶ã§ https://anke.jp ã«ã‚¢ã‚¯ã‚»ã‚¹

âœ… **ç¢ºèªé …ç›®**:
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«éµãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- è¨¼æ˜æ›¸ãŒæœ‰åŠ¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¢ºèªï¼‰

### **6-2. HTTPãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç¢ºèª**

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://anke.jp ã«ã‚¢ã‚¯ã‚»ã‚¹

âœ… è‡ªå‹•çš„ã« https://anke.jp ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

### **6-3. wwwã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèª**

ãƒ–ãƒ©ã‚¦ã‚¶ã§ https://www.anke.jp ã«ã‚¢ã‚¯ã‚»ã‚¹

âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### **6-4. SSLè¨¼æ˜æ›¸ã®è©³ç´°ã‚’ç¢ºèª**

ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®éµãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯

âœ… **ç¢ºèªé …ç›®**:
- **ç™ºè¡Œè€…**: Let's Encrypt
- **æœ‰åŠ¹æœŸé™**: ç´„90æ—¥å¾Œ
- **ãƒ‰ãƒ¡ã‚¤ãƒ³**: anke.jp, www.anke.jp

### **6-5. SSLãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã§ç¢ºèª**

https://www.ssllabs.com/ssltest/analyze.html?d=anke.jp

âœ… ã‚°ãƒ¬ãƒ¼ãƒ‰ A ã¾ãŸã¯ A+ ãŒç†æƒ³

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **ã‚¨ãƒ©ãƒ¼: DNS_PROBE_FINISHED_NXDOMAIN**

**åŸå› **: DNSãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯DNSä¼æ’­ãŒå®Œäº†ã—ã¦ã„ãªã„

**å¯¾å‡¦æ³•**:
1. DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
2. DNSä¼æ’­ã‚’å¾…ã¤ï¼ˆæœ€å¤§48æ™‚é–“ï¼‰
3. `dig anke.jp`ã§DNSã‚’ç¢ºèª

---

### **ã‚¨ãƒ©ãƒ¼: 502 Bad Gateway**

**åŸå› **: Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¦ã„ãªã„

**å¯¾å‡¦æ³•**:
```bash
# PM2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
pm2 status

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
pm2 restart anke-nextjs

# ãƒ­ã‚°ã‚’ç¢ºèª
pm2 logs anke-nextjs
```

---

### **ã‚¨ãƒ©ãƒ¼: SSLè¨¼æ˜æ›¸ã®å–å¾—ã«å¤±æ•—**

**åŸå› **: ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒVPSã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«è§£æ±ºã•ã‚Œã¦ã„ãªã„

**å¯¾å‡¦æ³•**:
1. DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
2. `dig anke.jp`ã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª
3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§ãƒãƒ¼ãƒˆ80ã¨443ãŒé–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèª

```bash
# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç¢ºèª
sudo ufw status

# ãƒãƒ¼ãƒˆ80ã¨443ã‚’é–‹ã
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

---

### **ã‚¨ãƒ©ãƒ¼: Mixed Contentï¼ˆæ··åœ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰**

**åŸå› **: HTTPSãƒšãƒ¼ã‚¸å†…ã§HTTPãƒªã‚½ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹

**å¯¾å‡¦æ³•**:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
2. ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’HTTPSã«å¤‰æ›´
3. ç’°å¢ƒå¤‰æ•°`NEXT_PUBLIC_APP_URL`ãŒæ­£ã—ã„ã‹ç¢ºèª

---

### **Nginxè¨­å®šã®ç¢ºèª**

```bash
# Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
sudo cat /etc/nginx/sites-available/anke.jp

# Nginxè¨­å®šã‚’ãƒ†ã‚¹ãƒˆ
sudo nginx -t

# Nginxã‚’ãƒªãƒ­ãƒ¼ãƒ‰
sudo systemctl reload nginx

# Nginxã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
systemctl status nginx

# Nginxã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
sudo tail -50 /var/log/nginx/anke.jp.error.log
```

---

## æœ€çµ‚çš„ãªã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼
  â†“
  https://anke.jp (HTTPSã€ãƒãƒ¼ãƒˆ443)
  â†“
  Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·)
  â”œâ”€ SSL/TLSçµ‚ç«¯ï¼ˆLet's Encryptè¨¼æ˜æ›¸ï¼‰
  â”œâ”€ HTTPãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆHTTP â†’ HTTPSï¼‰
  â””â”€ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  â†“
  Next.js (PM2ã§èµ·å‹•ã€ãƒãƒ¼ãƒˆ3000)
  â†“
  Supabase (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)
```

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### **Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**
```
/etc/nginx/
â”œâ”€â”€ nginx.conf                      # ãƒ¡ã‚¤ãƒ³è¨­å®š
â”œâ”€â”€ sites-available/
â”‚   â”œâ”€â”€ default                     # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆç„¡åŠ¹åŒ–æ¨å¥¨ï¼‰
â”‚   â””â”€â”€ anke.jp                     # anke.jpè¨­å®š â˜…
â””â”€â”€ sites-enabled/
    â””â”€â”€ anke.jp -> ../sites-available/anke.jp  # ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯
```

### **SSLè¨¼æ˜æ›¸**
```
/etc/letsencrypt/
â”œâ”€â”€ live/
â”‚   â””â”€â”€ anke.jp/
â”‚       â”œâ”€â”€ fullchain.pem           # è¨¼æ˜æ›¸ãƒã‚§ãƒ¼ãƒ³
â”‚       â”œâ”€â”€ privkey.pem             # ç§˜å¯†éµ
â”‚       â”œâ”€â”€ cert.pem                # è¨¼æ˜æ›¸
â”‚       â””â”€â”€ chain.pem               # ä¸­é–“è¨¼æ˜æ›¸
â””â”€â”€ renewal/
    â””â”€â”€ anke.jp.conf                # è‡ªå‹•æ›´æ–°è¨­å®š
```

### **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**
```
/var/log/nginx/
â”œâ”€â”€ anke.jp.access.log              # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
â””â”€â”€ anke.jp.error.log               # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
```

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ‰ãƒ¡ã‚¤ãƒ³ç§»è¡Œã¨SSLå°å…¥ã®ç¢ºèªäº‹é …ï¼š

### **ãƒ•ã‚§ãƒ¼ã‚º1: DNSè¨­å®š**
- [ ] ç¾åœ¨ã®DNSè¨­å®šã‚’ç¢ºèªï¼ˆ133.18.234.69 â†’ 133.18.122.123ã¸ã®å¤‰æ›´ãŒå¿…è¦ï¼‰
- [ ] DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆA: anke.jp â†’ 133.18.122.123ï¼‰
- [ ] DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆA: www.anke.jp â†’ 133.18.122.123ï¼‰
- [ ] SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹å ´åˆï¼‰
- [ ] DNSä¼æ’­ã‚’ç¢ºèªï¼ˆ`dig anke.jp`ã§133.18.122.123ãŒè¿”ã•ã‚Œã‚‹ï¼‰
- [ ] ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªï¼ˆwhatsmydns.netï¼‰

### **ãƒ•ã‚§ãƒ¼ã‚º2: Nginxè¨­å®š**
- [ ] Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆ`/etc/nginx/sites-available/anke.jp`ï¼‰
- [ ] ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
- [ ] Nginxè¨­å®šã‚’ãƒ†ã‚¹ãƒˆï¼ˆ`sudo nginx -t`ï¼‰
- [ ] Nginxã‚’ãƒªãƒ­ãƒ¼ãƒ‰
- [ ] Certbotã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] SSLè¨¼æ˜æ›¸ã‚’å–å¾—ï¼ˆ`sudo certbot --nginx`ï¼‰
- [ ] SSLè¨¼æ˜æ›¸ã‚’ç¢ºèªï¼ˆ`sudo certbot certificates`ï¼‰
- [ ] è‡ªå‹•æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆï¼ˆ`sudo certbot renew --dry-run`ï¼‰
- [ ] VPSã®.env.localã‚’æ›´æ–°ï¼ˆ`NEXT_PUBLIC_APP_URL=https://anke.jp`ï¼‰
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
- [ ] HTTPSã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèªï¼ˆhttps://anke.jpï¼‰
- [ ] HTTPãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç¢ºèªï¼ˆhttp://anke.jp â†’ https://anke.jpï¼‰
- [ ] SSLè¨¼æ˜æ›¸ã‚’ç¢ºèªï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®éµãƒãƒ¼ã‚¯ï¼‰
- [ ] SSLãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆSSL Labsï¼‰

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### **1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ **

`/etc/nginx/sites-available/anke.jp`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```nginx
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
```

### **2. SSLè¨­å®šã®å¼·åŒ–**

CertbotãŒè‡ªå‹•çš„ã«è¿½åŠ ã™ã‚‹SSLè¨­å®šã‚’ç¢ºèªï¼š

```bash
sudo cat /etc/nginx/sites-available/anke.jp | grep ssl_
```

---

## å‚è€ƒè³‡æ–™

- [Let's Encryptå…¬å¼ã‚µã‚¤ãƒˆ](https://letsencrypt.org/)
- [Certbotå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://certbot.eff.org/)
- [Nginxå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nginx.org/en/docs/)
- [SSL Labs SSL Test](https://www.ssllabs.com/ssltest/)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
