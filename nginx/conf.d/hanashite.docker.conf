# キャッシュゾーン定義
proxy_cache_path /var/cache/nginx/anke 
    levels=1:2 
    keys_zone=anke_cache:10m 
    max_size=1g 
    inactive=60m 
    use_temp_path=off;

# アップストリーム（Next.jsアプリ - ホストマシンのlocalhost:3000）
upstream nextjs_backend {
    server host.docker.internal:3000;
    keepalive 64;
}

server {
    listen 80;
    listen [::]:80;
    server_name localhost;

    # 全てのリクエストをNext.jsにプロキシ（マイクロキャッシュ付き）
    location / {
        # ISRと組み合わせたマイクロキャッシュ
        proxy_cache anke_cache;
        proxy_cache_valid 200 60s;  # 60秒間キャッシュ
        proxy_cache_use_stale error timeout updating;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        # POSTリクエストとクエリパラメータ付きURLはキャッシュしない
        proxy_cache_bypass $request_method = POST;
        proxy_cache_bypass $is_args;
        proxy_no_cache $request_method = POST;
        proxy_no_cache $is_args;
        
        # WebSocketアップグレードもバイパス
        proxy_cache_bypass $http_upgrade;
        
        # Next.jsのCache-Controlヘッダーを無視してキャッシュ
        proxy_ignore_headers Cache-Control;
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=60";
        
        # キャッシュステータスをヘッダーに追加
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Served-By "Nginx-Proxy";

        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ログイン必須ページはキャッシュしない
    location ~ ^/(mypage|profileset|point|phistory|myanke|favorites|inquiry|report) {
        proxy_pass http://nextjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Cache-Status "BYPASS";
        add_header X-Served-By "Nginx-Proxy-NoCache";
    }
}
